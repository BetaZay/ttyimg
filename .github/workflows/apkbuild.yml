# .github/workflows/build-apk.yml

name: Build APK (Alpine Linux)

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Install build tools
        run: |
          apk update
          apk add alpine-sdk cmake git libdrm libdrm-dev pkgconf curl

      - name: Set up user for abuild
        run: |
            adduser -D builder
            addgroup builder abuild
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            mkdir -p /home/builder/packages/ttyimg
            chown -R builder /home/builder
            chown -R builder /var/cache/distfiles
  

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          path: ttyimg-src

      - name: Create tarball and APKBUILD
        run: |
          cd ttyimg-src
          tar -czf ttyimg-1.0.tar.gz --transform 's,^,ttyimg-1.0/,' *
          mv ttyimg-1.0.tar.gz /home/builder/packages/ttyimg/
          cp APKBUILD /home/builder/packages/ttyimg/
          chown builder /home/builder/packages/ttyimg/*

      - name: Build APK
        run: |
            su builder -c "abuild-keygen -a -n"
            PUBKEY=$(find /home/builder/.abuild -name '*.rsa.pub' | head -n 1)
            PRIVKEY=$(find /home/builder/.abuild -name '*.rsa' | head -n 1)
  
            # Trust the public key
            cp "$PUBKEY" /etc/apk/keys/
  
            # Add private key to abuild config
            echo "PACKAGER_PRIVKEY=\"$PRIVKEY\"" >> /home/builder/.abuild/abuild.conf
            chown builder /etc/apk/keys/$(basename "$PUBKEY")
  
            su builder -c "cd /home/builder/packages/ttyimg && abuild checksum && abuild -r"
  
      - name: List APK output
        run: ls -lh /home/builder/packages/x86_64

      - name: Copy APK to /tmp for upload
        run: |
          cp /home/builder/packages/x86_64/*.apk /tmp/

      - name: Upload built APK
        uses: actions/upload-artifact@v4
        with:
            name: ttyimg-apk
            path: /tmp/*.apk
  